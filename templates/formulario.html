<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Permiso Universal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      background: #011627;
      font-family: monospace;
      color: white;
      padding: 20px;
      text-align: center;
    }
    input, select, textarea, button {
      padding: 10px;
      margin: 5px;
      width: 90%;
      max-width: 400px;
      font-size: 16px;
      border-radius: 8px;
      border: none;
    }
    input, textarea, select {
      background: #d1f7c4;
      color: #000;
      text-transform: uppercase;
    }
    button {
      background: #ff3366;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }
    form {
      background: #022b3a;
      padding: 20px;
      border-radius: 10px;
      margin: 0 auto;
    }
    .toggle {
      margin-top: 10px;
    }
    .volver-btn {
      background: #00bcd4;
      margin-top: 10px;
      width: auto;
      display: inline-block;
    }
  </style>
</head>
<body>
  <h1>Permiso Universal</h1>

  <form method="POST">
    <input type="text" name="marca" placeholder="Marca" id="marca" required>
    <input type="text" name="linea" placeholder="Línea" id="linea" required>
    <input type="text" name="anio" placeholder="Año" id="anio" required>
    <input type="text" name="serie" placeholder="Número de Serie" id="serie" required>
    <input type="text" name="motor" placeholder="Número de Motor" id="motor" required>
    <input type="text" name="color" placeholder="Color" id="color" required>
    <input type="text" name="contribuyente" placeholder="Nombre del Contribuyente" id="contribuyente" required>

    <label for="validez" style="display:block; text-align:left; margin-left:5%;">Días de validez:</label>
    <select name="validez" id="validez" required>
      <option value="30" selected>30 días</option>
      <option value="60">60 días</option>
      <option value="90">90 días</option>
    </select>

    <button type="submit">Generar PDF</button>
    <a href="{{ url_for('panel') }}">
      <button type="button" class="volver-btn">Volver al Menú Principal</button>
    </a>
  </form>

  <div class="toggle">
    <label>
      <input type="checkbox" id="modoAuto" checked>
      Activar detección automática
    </label>
  </div>

  <h3 style="margin-top:30px;">Texto automático:</h3>
  <textarea id="autotexto" rows="8" placeholder="Pega todo el desmadre aquí..."></textarea>

  <script>
    async function decodificarVIN(vin) {
      if (!vin || vin.length < 11) return;
      const url = `https://vpic.nhtsa.dot.gov/api/vehicles/DecodeVinValues/${vin}?format=json`;
      try {
        const res = await fetch(url);
        const info = (await res.json()).Results[0];
        if (info.Make) document.getElementById("marca").value = info.Make.toUpperCase();
        if (info.Model) document.getElementById("linea").value = info.Model.toUpperCase();
        if (info.ModelYear) document.getElementById("anio").value = info.ModelYear;
        // eliminado manejo de BodyClass (tipo)
      } catch (err) {
        console.log("Error al decodificar VIN:", err);
      }
    }

    const motores_sin = ["SIN NÚMERO", "SIN NUMERO", "S/N", "SN", "S N", "NO TIENE", "NO CUENTA"];
    const lineas = ["F150", "F-150", "CRUZE", "TSURU", "JETTA", "CIVIC", "SPARK", "RAV4",
                    "HILUX", "SENTRA", "RIO", "VERSA", "X-TERRA", "AEROSTAR"];

    document.getElementById("autotexto").addEventListener("input", () => {
      if (!document.getElementById("modoAuto").checked) return;
      const texto = document.getElementById("autotexto").value.toUpperCase();

      const marcas = ["FORD","CHEVROLET","NISSAN","VOLKSWAGEN","ITALIKA","TOYOTA","HONDA","DODGE","BMW","KIA","RAM"];
      for (let m of marcas) if (texto.includes(m)) document.getElementById("marca").value = m;
      for (let l of lineas) if (texto.includes(l)) document.getElementById("linea").value = l.replace("-","");
      
      const añoMatch = texto.match(/\b(1[4-9][0-9]{2}|20[0-9]{2}|[2-4][0-9]{4})\b/);
      if (añoMatch) document.getElementById("anio").value = añoMatch[0];

      const vinMatch = texto.match(/\b[A-HJ-NPR-Z0-9]{11,17}\b/);
      if (vinMatch) {
        document.getElementById("serie").value = vinMatch[0];
        decodificarVIN(vinMatch[0]);
      }

      const sinMotor = motores_sin.find(v => texto.includes(v));
      if (sinMotor) {
        document.getElementById("motor").value = "SIN NÚMERO";
      } else {
        const motorMatch = texto.match(/HECHO EN [A-ZÁÉÍÓÚÑ \/\-]{3,}/);
        if (motorMatch) document.getElementById("motor").value = motorMatch[0];
      }

      const colores = ["NEGRO","BLANCO","ROJO","AZUL","VERDE","GRIS","AMARILLO","DORADO","ROSA","CAFÉ","NARANJA"];
      for (let color of colores) if (texto.includes(color)) document.getElementById("color").value = color;

      const lines = texto.split("\n").map(x => x.trim()).filter(l => l.length>2);
      for (let i = lines.length-1; i>=0; i--) {
        if (/^[A-ZÁÉÍÓÚÑ ]{4,}$/.test(lines[i])) {
          document.getElementById("contribuyente").value = lines[i];
          break;
        }
      }
    });
  </script>
</body>
</html>
